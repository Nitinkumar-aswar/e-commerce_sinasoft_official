<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Products | AutoKart Admin</title>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f6f8;
    }

    .header {
      background: #1f2a30;
      color: #fff;
      padding: 15px 30px;
      font-size: 20px;
    }

    .layout {
      display: flex;
    }

    .sidebar {
      width: 220px;
      background: #263238;
      min-height: 100vh;
    }

    .sidebar a {
      display: block;
      padding: 12px 20px;
      color: #ddd;
      text-decoration: none;
    }

    .sidebar a:hover {
      background: #37474f;
      color: #fff;
    }

    .content {
      flex: 1;
      padding: 25px;
    }

    .card {
      background: #fff;
      padding: 20px;
      border-radius: 6px;
      margin-bottom: 25px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      width: 100%;
    }

    .form-group {
      margin-bottom: 20px;
      width: 100%;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
      font-size: 14px;
    }

    input, select, .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }

    input:focus, select:focus, .form-control:focus {
      border-color: #2874f0;
      outline: none;
      box-shadow: 0 0 0 2px rgba(40, 116, 240, 0.1);
    }
    
    /* Style for read-only price field */
    #editPrice, #price {
      background-color: #f8f9fa;
      cursor: not-allowed;
    }

    #editPrice:focus {
      outline: none;
      border-color: #ddd;
      box-shadow: none;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      font-size: 14px;
      box-sizing: border-box;
    }

    .form-actions {
      grid-column: 1 / -1;
      text-align: right;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    button {
      background: #2874f0;
      color: #fff;
      border: none;
      padding: 10px 22px;
      border-radius: 4px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
      text-align: left;
    }

    th {
      background: #f1f3f5;
    }

    img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
    }

    .action-btn {
      background: none;
      border: none;
      color: #2874f0;
      cursor: pointer;
      margin-right: 10px;
      font-size: 13px;
    }

    /* SEARCH + HEADER */
    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .search-input {
      width: 260px;
    }

    /* PAGINATION */
    .pagination {
      margin-top: 20px;
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .pagination button {
      padding: 6px 12px;
      border: 1px solid #ccc;
      background: #eee;
      cursor: pointer;
      border-radius: 4px;
    }

    .pagination button.active {
      background: #2874f0;
      color: #fff;
      border-color: #2874f0;
    }

    /* MODAL */
    .modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 1000;
  pointer-events: none;
}

.modal.active {
  display: block;
  pointer-events: auto;
}


    

    .modal-box {
  background: #fff;
  width: 600px;
  margin: 60px auto;
  padding: 20px;
  border-radius: 6px;

  /* ðŸ‘‡ ADD ONLY THIS */
  max-height: 85vh;
  overflow-y: auto;
}

.toast-success {
  position: fixed;
  top: 20px;
  right: 20px;

  background: #2e7d32;
  color: #fff;

  padding: 14px 22px;
  border-radius: 6px;

  font-size: 14px;
  font-weight: 500;

  display: none;
  z-index: 9999;

  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}




/* ---------- MOBILE â‰¤480px ---------- */
@media (max-width: 480px) {

  .layout {
    flex-direction: column;
  }

  .sidebar {
    width: 100%;
    min-height: auto;
    display: flex;
    overflow-x: auto;
  }

  .sidebar a {
    flex: 1;
    text-align: center;
    font-size: 13px;
    padding: 10px;
    white-space: nowrap;
  }

  .content {
    padding: 15px;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .form-actions {
    text-align: center;
  }

  .list-header {
    flex-direction: column;
    gap: 10px;
    align-items: stretch;
  }

  .search-input {
    width: 100%;
  }

  table {
    font-size: 13px;
    min-width: 700px;
  }

  .modal-box {
    width: 95%;
    margin: 20px auto;
  }
}

/* ---------- TABLET 481px â€“ 768px ---------- */
@media (min-width: 481px) and (max-width: 768px) {

  .sidebar {
    width: 180px;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .search-input {
    width: 100%;
  }

  table {
    min-width: 800px;
  }

  .modal-box {
    width: 90%;
  }
}

/* ---------- LAPTOP 769px â€“ 1024px ---------- */
@media (min-width: 769px) and (max-width: 1024px) {

  .sidebar {
    width: 200px;
  }

  .form-grid {
    grid-template-columns: 1fr 1fr;
  }

  table {
    font-size: 14px;
  }
}

  </style>
</head>

<body>

<div class="header">AutoKart Admin Panel</div>

<div class="layout">

  <div class="sidebar">
    <a href="/admin">Dashboard</a>
    <a href="/admin/products">Products</a>
    <a href="/">Go to Website</a>
  </div>

  <div class="content">

    <!-- ADD PRODUCT (UNCHANGED) -->
    <div class="card">
      <h3>Add Product</h3>

      <form method="POST" action="/admin/products" enctype="multipart/form-data">
        <div class="form-grid">

          <div class="form-group">
            <label for="sectionSelect">Section</label>
            <select id="sectionSelect" name="section_id" class="form-control" required>
              <option value="">Select Section</option>
              <% sections.forEach(section => { %>
                <option value="<%= section.id %>"><%= section.name %></option>
              <% }) %>
            </select>
          </div>

          <div class="form-group">
            <label for="subSectionSelect">Sub Section</label>
            <select id="subSectionSelect" name="sub_section_id" class="form-control" required>
              <option value="">Select Sub Section</option>
            </select>
          </div>

          <div class="form-group">
            <label for="productName">Product Name</label>
            <input type="text" id="productName" name="product_name" class="form-control" required>
          </div>

          <div class="form-group">
            <label for="originalPrice">Original Price (â‚¹)</label>
            <input type="number" id="originalPrice" name="original_price" class="form-control" step="0.01" required>
          </div>

          <div class="form-group">
            <label for="discount">Discount (%)</label>
            <input type="number" id="discount" name="discount" class="form-control" min="0" max="100" step="0.01" required>
          </div>

          <div class="form-group">
            <label for="price">Price (â‚¹)</label>
            <input type="number" id="price" name="price" class="form-control" step="0.01" required readonly>
          </div>

          <script>
            const originalPriceInput = document.getElementById('originalPrice');
            const discountInput = document.getElementById('discount');
            const priceInput = document.getElementById('price');

            function calculatePrice() {
              const originalPrice = parseFloat(originalPriceInput.value);
              const discount = parseFloat(discountInput.value);

              if (!isNaN(originalPrice) && !isNaN(discount)) {
                const discountAmount = (originalPrice * discount) / 100;
                const finalPrice = originalPrice - discountAmount;
                priceInput.value = finalPrice.toFixed(2);
              }
            }

            originalPriceInput.addEventListener('input', calculatePrice);
            discountInput.addEventListener('input', calculatePrice);
          </script>
          
          <div class="form-group">
            <label for="quantity">Quantity</label>
            <input type="number" id="quantity" name="quantity" class="form-control" required>
          </div>

          <div class="form-group">
            <label for="productImage">Main Product Image</label>
            <input type="file" id="productImage" name="product_image" class="form-control" required>
            <p class="help-text">This will be the main display image</p>
          </div>

          <div class="form-group">
            <label for="galleryImages">Gallery Images (Max 5)</label>
            <input type="file" id="galleryImages" name="gallery_images[]" class="form-control" multiple accept="image/*">
            <p class="help-text">Additional product images (optional)</p>
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label for="addProductDesc">Product Description</label>
            <textarea 
              name="product_description" 
              id="addProductDesc" 
              class="form-control"
              rows="4"
              placeholder="Enter product description..."
              required
            ></textarea>
          </div>

          <div class="form-actions">
            <button type="submit">Save Product</button>
          </div>

        </div>
      </form>
    </div>

    <!-- PRODUCT LIST -->
    <div class="card">

      <div class="list-header">
        <h3>Product List</h3>

        <input
          type="text"
          id="productSearch"
          class="search-input"
          placeholder="Search product name..."
        >
      </div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Image</th>
            <th>Name</th>
            <th>Section</th>
            <th>Price</th>
            <th>Original Price</th>
            <th>Discount %</th>
            <th>Qty</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody id="productTable">
          <% products.forEach((p, i) => { %>
            <tr data-name="<%= p.product_name.toLowerCase() %>">
              <td><%= i + 1 %></td>
              <td><img src="/uploads/<%= p.image %>"></td>
              <td title="<%= p.product_name %>">
                <% 
                const words = p.product_name.split(' ');
                const displayName = words.slice(0, 4).join(' ') + (words.length > 4 ? '...' : '');
                %>
                <%= displayName %>
              </td>
              <td><%= p.section_name %></td>
              <td>â‚¹<%= p.price %></td>
              <td>â‚¹<%= p.original_price || p.price %></td>
              <td><%= p.discount ? p.discount + '%' : '0%' %></td>
              <td><%= p.quantity %></td>
              <td>
                <button
                  type="button"
                  class="action-btn edit-btn"
                  data-id="<%= p.id %>"
                  data-name="<%= p.product_name %>"
                  data-price="<%= p.price %>"
                  data-original-price="<%= p.original_price || p.price %>"
                  data-discount="<%= p.discount || 0 %>"
                  data-quantity="<%= p.quantity %>"
                  data-desc="<%= p.product_description || '' %>"
                  data-section="<%= p.section_id %>"
                  data-subsection="<%= p.sub_section_id %>"
                >
                  Edit
                </button>

                <a
                  class="action-btn"
                  href="/admin/products/delete/<%= p.id %>"
                  onclick="return confirm('Delete this product?')"
                >
                  Delete
                </a>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <div class="pagination" id="pagination"></div>

    </div>

  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal" id="editModal">
  <div class="modal-box">
    <h3>Edit Product</h3>
    <form id="editForm" method="POST" enctype="multipart/form-data" action="">

      <label>Section</label>
      <select name="section_id" id="editSection">
        <% sections.forEach(section => { %>
          <option value="<%= section.id %>"><%= section.name %></option>
        <% }) %>
      </select>

      <br><br>

      <label>Sub Section</label>
      <select name="sub_section_id" id="editSubSection"></select>

      <br><br>

      <label>Product Name</label>
      <input type="text" name="product_name" id="editName">

      <br><br>

      <label>Original Price (â‚¹)</label>
      <input type="number" id="editOriginalPrice" name="original_price" step="0.01" required>

      <br><br>

      <label>Discount (%)</label>
      <input type="number" id="editDiscount" name="discount" min="0" max="100" step="0.01" required>

      <br><br>

      <label>Price (â‚¹)</label>
      <input type="number" id="editPrice" name="price" step="0.01" required readonly>

      <br><br>

      <label>Quantity</label>
      <input type="number" name="quantity" id="editQuantity">

      <br><br>

      <div class="form-group">
        <label for="editDesc">Description</label>
        <textarea 
          name="product_description" 
          id="editDesc" 
          class="form-control"
          rows="4"
          style="min-height: 100px; resize: vertical; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
          placeholder="Enter product description..."
        ></textarea>
      </div>

      <br>

      <label>Change Image (optional)</label>
      <input type="file" name="product_image">

      <br><br>
     <label>Gallery Images (Max 5)</label>
<input type="file" name="gallery_images[]" multiple>

<br><br>

      <button type="submit">Update</button>
      <button type="button" onclick="closeEditModal()">Cancel</button>

    </form>
  </div>
</div>

<script>
  /* EXISTING DROPDOWN + EDIT LOGIC â€” UNTOUCHED */

  const sectionSelect = document.getElementById("sectionSelect");
  const subSectionSelect = document.getElementById("subSectionSelect");

  if (sectionSelect && subSectionSelect) {
    sectionSelect.addEventListener("change", () => {

      subSectionSelect.innerHTML = '<option value="">Select Sub Section</option>';

      if (!sectionSelect.value) return;

      fetch("/admin/api/subsections/" + sectionSelect.value)
        .then(res => res.json())
        .then(data => {
          data.forEach(sub => {
            const opt = document.createElement("option");
            opt.value = sub.id;
            opt.textContent = sub.name;
            subSectionSelect.appendChild(opt);
          });
        });
    });
  }


</script>
<script>
  const editModal = document.getElementById("editModal");
  const editForm = document.getElementById("editForm");
  const editSection = document.getElementById("editSection");
  const editSubSection = document.getElementById("editSubSection");
  
  // Price calculation function
  function calculateEditPrice() {
    const originalPrice = parseFloat(document.getElementById('editOriginalPrice').value) || 0;
    const discount = parseFloat(document.getElementById('editDiscount').value) || 0;
    const priceField = document.getElementById('editPrice');
    
    if (originalPrice > 0) {
      if (discount > 0) {
        const discountAmount = (originalPrice * discount) / 100;
        const finalPrice = originalPrice - discountAmount;
        priceField.value = finalPrice.toFixed(2);
      } else {
        priceField.value = originalPrice.toFixed(2);
      }
    } else {
      priceField.value = '';
    }
  }
  
  // Initialize event listeners
  function initializePriceCalculation() {
    const originalPriceInput = document.getElementById('editOriginalPrice');
    const discountInput = document.getElementById('editDiscount');
    const priceField = document.getElementById('editPrice');
    
    if (originalPriceInput && discountInput) {
      // Clone inputs to remove any existing event listeners
      const newOriginalPrice = originalPriceInput.cloneNode(true);
      const newDiscount = discountInput.cloneNode(true);
      
      originalPriceInput.parentNode.replaceChild(newOriginalPrice, originalPriceInput);
      discountInput.parentNode.replaceChild(newDiscount, discountInput);
      
      // Add new event listeners
      newOriginalPrice.addEventListener('input', calculateEditPrice);
      newDiscount.addEventListener('input', calculateEditPrice);
      
      // Make price field read-only
      if (priceField) {
        priceField.readOnly = true;
      }
    }
  }
  
  // Price calculation function
  function calculateEditPrice() {
    try {
      const originalPrice = parseFloat(document.getElementById('editOriginalPrice').value) || 0;
      let discount = parseFloat(document.getElementById('editDiscount').value) || 0;
      const priceField = document.getElementById('editPrice');
      
      // Ensure discount is between 0 and 100
      discount = Math.min(100, Math.max(0, discount));
      
      if (originalPrice > 0) {
        const discountAmount = (originalPrice * discount) / 100;
        const finalPrice = originalPrice - discountAmount;
        priceField.value = finalPrice.toFixed(2);
      } else {
        priceField.value = '';
      }
      
      // Update the discount input to ensure it's within bounds
      if (document.getElementById('editDiscount').value !== discount.toString()) {
        document.getElementById('editDiscount').value = discount;
      }
      
      return true;
    } catch (error) {
      console.error('Error in price calculation:', error);
      return false;
    }
  }

  // Initialize price calculation when the DOM is loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Get the input elements
    const originalPriceInput = document.getElementById('editOriginalPrice');
    const discountInput = document.getElementById('editDiscount');
    
    // Add event listeners for real-time calculation
    if (originalPriceInput && discountInput) {
      // Function to handle input events with debounce
      const handlePriceInput = () => {
        calculateEditPrice();
      };
      
      // Add event listeners
      originalPriceInput.addEventListener('input', handlePriceInput);
      discountInput.addEventListener('input', handlePriceInput);
      
      // Initial calculation
      calculateEditPrice();
    }
  });

  // Form submission handler
  if (editForm) {
    editForm.addEventListener("submit", function(e) {
      e.preventDefault();
      
      // Ensure price is calculated before submission
      calculateEditPrice();
      
      // Create FormData object
      const formData = new FormData(this);
      
      // Get all form values
      const originalPrice = document.getElementById('editOriginalPrice').value || '0';
      const discount = document.getElementById('editDiscount').value || '0';
      const price = document.getElementById('editPrice').value || originalPrice;
      
      // Ensure all required fields are set
      formData.set('original_price', originalPrice);
      formData.set('discount', discount);
      formData.set('price', price);
      
      // Log form data for debugging
      console.log('Submitting form with:', {
        original_price: originalPrice,
        discount: discount,
        price: price
      });
      
      // Submit the form using fetch
      fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
          // Don't set Content-Type header when using FormData with files
          // The browser will set it with the correct boundary
        }
      })
      .then(response => {
        if (response.redirected) {
          window.location.href = response.url;
        } else {
          return response.text().then(text => {
            console.error('Unexpected response:', text);
            alert('Error updating product. Please check console for details.');
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error updating product: ' + error.message);
      });
    });
  }

  // Function to show modal
  function showEditModal() {
    editModal.style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent scrolling
  }

  // Function to hide modal
  function hideEditModal() {
    editModal.style.display = 'none';
    document.body.style.overflow = 'auto'; // Re-enable scrolling
  }

  // Close modal when clicking outside of it
  editModal.addEventListener('click', (e) => {
    if (e.target === editModal) {
      hideEditModal();
    }
  });

  // Close button
  const closeButton = editModal.querySelector('button[type="button"]');
  if (closeButton) {
    closeButton.addEventListener('click', hideEditModal);
  }

  // Set up event listeners for price calculation
  if (editOriginalPrice && editDiscount) {
    // Remove any existing listeners to prevent duplicates
    const newOriginalPrice = editOriginalPrice.cloneNode(true);
    const newDiscount = editDiscount.cloneNode(true);
    
    editOriginalPrice.parentNode.replaceChild(newOriginalPrice, editOriginalPrice);
    editDiscount.parentNode.replaceChild(newDiscount, editDiscount);
    
    // Add new event listeners
    newOriginalPrice.addEventListener('input', calculateEditPrice);
    newDiscount.addEventListener('input', calculateEditPrice);
  }

  // Edit button click handler
  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      
      // Show the modal
      showEditModal();
      
      // Set form action
      const productId = btn.getAttribute('data-id');
      editForm.action = "/admin/products/edit/" + productId;
      
      // Get all data attributes
      const name = btn.getAttribute('data-name') || '';
      const originalPrice = btn.getAttribute('data-original-price') || btn.getAttribute('data-price') || '';
      const discount = btn.getAttribute('data-discount') || '0';
      const price = btn.getAttribute('data-price') || '';
      const quantity = btn.getAttribute('data-quantity') || '';
      const desc = btn.getAttribute('data-desc') || '';
      const section = btn.getAttribute('data-section') || '';
      const subsection = btn.getAttribute('data-subsection') || '';
      
      // Set form field values
      document.getElementById("editName").value = name;
      document.getElementById("editOriginalPrice").value = originalPrice;
      document.getElementById("editDiscount").value = discount;
      document.getElementById("editPrice").value = price;
      document.getElementById("editQuantity").value = quantity;
      
      // Handle description - properly escape HTML entities
      const descTextarea = document.getElementById("editDesc");
      descTextarea.value = desc.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&#39;/g, "'");
      
      // Set section and trigger change to load subsections
      if (editSection) {
        editSection.value = section;
        // Trigger change event to load subsections
        const event = new Event('change');
        editSection.dispatchEvent(event);
        
        // Set subsection after a small delay to ensure subsections are loaded
        setTimeout(() => {
          if (editSubSection && subsection) {
            editSubSection.value = subsection;
          }
        }, 100);
      }
      
      // Re-initialize price calculation
      initializePriceCalculation();
      
      // Calculate initial price
      setTimeout(calculateEditPrice, 100);

      editSubSection.innerHTML = "";

      fetch("/admin/api/subsections/" + btn.dataset.section)
        .then(res => res.json())
        .then(data => {
          data.forEach(sub => {
            const opt = document.createElement("option");
            opt.value = sub.id;
            opt.textContent = sub.name;

            if (String(sub.id) === String(btn.dataset.subsection)) {
              opt.selected = true;
            }

            editSubSection.appendChild(opt);
          });
        });

      editModal.classList.add("active");
    });
  });

  editSection.addEventListener("change", () => {
    editSubSection.innerHTML = '<option value="">Select Sub Section</option>';

    if (!editSection.value) return;

    fetch("/admin/api/subsections/" + editSection.value)
      .then(res => res.json())
      .then(data => {
        data.forEach(sub => {
          const opt = document.createElement("option");
          opt.value = sub.id;
          opt.textContent = sub.name;
          editSubSection.appendChild(opt);
        });
      });
  });

  function closeEditModal() {
    editModal.classList.remove("active");
  }
</script>

<script>
  /* SEARCH + PAGINATION (ISOLATED SAFE SCRIPT) */

  const searchInput = document.getElementById("productSearch");
  const tableBody = document.getElementById("productTable");
  const pagination = document.getElementById("pagination");

  const rows = Array.from(tableBody.querySelectorAll("tr"));
  const rowsPerPage = 10;
  let currentPage = 1;
  let filteredRows = rows;

  function renderTable() {
    rows.forEach(row => row.style.display = "none");

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    filteredRows.slice(start, end).forEach(row => {
      row.style.display = "";
    });

    renderPagination();
  }

  function renderPagination() {
    pagination.innerHTML = "";
    const totalPages = Math.ceil(filteredRows.length / rowsPerPage);

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;

      if (i === currentPage) {
        btn.classList.add("active");
      }

      btn.addEventListener("click", () => {
        currentPage = i;
        renderTable();
      });

      pagination.appendChild(btn);
    }
  }

  searchInput.addEventListener("input", () => {
    const value = searchInput.value.toLowerCase();

    filteredRows = rows.filter(row =>
      row.dataset.name.includes(value)
    );

    currentPage = 1;
    renderTable();
  });

  renderTable();
</script>
<% if (successMessage) { %>
<script>
  const toast = document.getElementById("successToast");
  toast.style.display = "block";

  setTimeout(() => {
    toast.style.display = "none";
  }, 3000);
</script>
<% } %>


<!-- SUCCESS TOAST -->
<div id="successToast" class="toast-success">
  âœ… Product added successfully
</div>

</body>
</html>
