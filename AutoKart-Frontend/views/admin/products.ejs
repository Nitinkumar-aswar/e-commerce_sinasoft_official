<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Products | AutoKart Admin</title>

  <style>
   

    .card {
      background: #fff;
      padding: 20px;
      border-radius: 6px;
      margin-bottom: 25px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px 20px;
    }

    label {
      font-size: 13px;
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }

    input, select, textarea {
      width: 100%;
      padding: 9px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    textarea {
      min-height: 90px;
      resize: vertical;
    }

    .form-actions {
      grid-column: 1 / -1;
      text-align: right;
    }

    button {
      background: #2874f0;
      color: #fff;
      border: none;
      padding: 10px 22px;
      border-radius: 4px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
      text-align: left;
    }

    th {
      background: #f1f3f5;
    }

    img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
    }

    .action-btn {
      background: none;
      border: none;
      color: #2874f0;
      cursor: pointer;
      margin-right: 10px;
      font-size: 13px;
    }

    /* SEARCH + HEADER */
    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .search-input {
      width: 260px;
    }

    /* PAGINATION */
    .pagination {
      margin-top: 20px;
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .pagination button {
      padding: 6px 12px;
      border: 1px solid #ccc;
      background: #eee;
      cursor: pointer;
      border-radius: 4px;
    }

    .pagination button.active {
      background: #2874f0;
      color: #fff;
      border-color: #2874f0;
    }

    /* MODAL */
    .modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 1000;
  pointer-events: none;
}

.modal.active {
  display: block;
  pointer-events: auto;
}


    

    .modal-box {
  background: #fff;
  width: 600px;
  margin: 60px auto;
  padding: 20px;
  border-radius: 6px;

  /* ðŸ‘‡ ADD ONLY THIS */
  max-height: 85vh;
  overflow-y: auto;
}

.toast-success {
  position: fixed;
  top: 20px;
  right: 20px;

  background: #2e7d32;
  color: #fff;

  padding: 14px 22px;
  border-radius: 6px;

  font-size: 14px;
  font-weight: 500;

  display: none;
  z-index: 9999;

  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}




/* ---------- MOBILE â‰¤480px ---------- */
@media (max-width: 480px) {

  .layout {
    flex-direction: column;
  }

  .sidebar {
    width: 100%;
    min-height: auto;
    display: flex;
    overflow-x: auto;
  }

  .sidebar a {
    flex: 1;
    text-align: center;
    font-size: 13px;
    padding: 10px;
    white-space: nowrap;
  }

  .content {
    padding: 15px;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .form-actions {
    text-align: center;
  }

  .list-header {
    flex-direction: column;
    gap: 10px;
    align-items: stretch;
  }

  .search-input {
    width: 100%;
  }

  table {
    font-size: 13px;
    min-width: 700px;
  }

  .modal-box {
    width: 95%;
    margin: 20px auto;
  }
}

/* ---------- TABLET 481px â€“ 768px ---------- */
@media (min-width: 481px) and (max-width: 768px) {

  .sidebar {
    width: 180px;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .search-input {
    width: 100%;
  }

  table {
    min-width: 800px;
  }

  .modal-box {
    width: 90%;
  }
}

/* ---------- LAPTOP 769px â€“ 1024px ---------- */
@media (min-width: 769px) and (max-width: 1024px) {

  .sidebar {
    width: 200px;
  }

  .form-grid {
    grid-template-columns: 1fr 1fr;
  }

  table {
    font-size: 14px;
  }
}

  </style>
</head>

<body>




  <div class="content">

    <!-- ADD PRODUCT (UNCHANGED) -->
    <div class="card">
      <h3>Add Product</h3>

      <form method="POST" action="/admin/products" enctype="multipart/form-data">
        <div class="form-grid">

          <div>
            <label>Section</label>
            <select id="sectionSelect" name="section_id" required>
              <option value="">Select Section</option>
              <% sections.forEach(section => { %>
                <option value="<%= section.id %>"><%= section.name %></option>
              <% }) %>
            </select>
          </div>

          <div>
            <label>Sub Section</label>
            <select id="subSectionSelect" name="sub_section_id" required>
              <option value="">Select Sub Section</option>
            </select>
          </div>

          <div>
            <label>Product Name</label>
            <input type="text" name="product_name" required>
          </div>

          <div>
            <label>Price (â‚¹)</label>
            <input type="number" name="price" required>
          </div>

          <div>
            <label>Quantity</label>
            <input type="number" name="quantity" required>
          </div>

          <div>
            <label>Product Image</label>
            <input type="file" name="product_image" required>
          </div>
            <div>
  <label>Gallery Images (Max 5)</label>
<input type="file" name="gallery_images[]" multiple accept="image/*">


</div>

          <div>
            <label>Product Description</label>
            <textarea name="product_description"></textarea>
          </div>

          <div class="form-actions">
            <button type="submit">Save Product</button>
          </div>

        </div>
      </form>
    </div>

    <!-- PRODUCT LIST -->
    <div class="card">

      <div class="list-header">
        <h3>Product List</h3>

        <input
          type="text"
          id="productSearch"
          class="search-input"
          placeholder="Search product name..."
        >
      </div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Image</th>
            <th>Name</th>
            <th>Section</th>
            <th>Price</th>
            <th>Qty</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody id="productTable">
          <% products.forEach((p, i) => { %>
            <tr data-name="<%= p.product_name.toLowerCase() %>">
              <td><%= i + 1 %></td>
              <td><img src="/uploads/<%= p.image %>"></td>
              <td><%= p.product_name %></td>
              <td><%= p.section_name %></td>
              <td>â‚¹ <%= p.price %></td>
              <td><%= p.quantity %></td>
              <td>
                <button
                  type="button"
                  class="action-btn edit-btn"
                  data-id="<%= p.id %>"
                  data-name="<%= p.product_name %>"
                  data-price="<%= p.price %>"
                  data-quantity="<%= p.quantity %>"
                  data-desc="<%= p.product_description || '' %>"
                  data-section="<%= p.section_id %>"
                  data-subsection="<%= p.sub_section_id %>"
                >
                  Edit
                </button>

                <a
                  class="action-btn"
                  href="/admin/products/delete/<%= p.id %>"
                  onclick="return confirm('Delete this product?')"
                >
                  Delete
                </a>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <div class="pagination" id="pagination"></div>

    </div>

  </div>
</div>

<!-- EDIT MODAL (UNCHANGED) -->
<div class="modal" id="editModal">
  <div class="modal-box">
    <h3>Edit Product</h3>
    <form id="editForm" method="POST" enctype="multipart/form-data">

      <label>Section</label>
      <select name="section_id" id="editSection">
        <% sections.forEach(section => { %>
          <option value="<%= section.id %>"><%= section.name %></option>
        <% }) %>
      </select>

      <br><br>

      <label>Sub Section</label>
      <select name="sub_section_id" id="editSubSection"></select>

      <br><br>

      <label>Product Name</label>
      <input type="text" name="product_name" id="editName">

      <br><br>

      <label>Price</label>
      <input type="number" name="price" id="editPrice">

      <br><br>

      <label>Quantity</label>
      <input type="number" name="quantity" id="editQuantity">

      <br><br>

      <label>Description</label>
      <textarea name="product_description" id="editDesc"></textarea>

      <br><br>

      <label>Change Image (optional)</label>
      <input type="file" name="product_image">

      <br><br>
     <label>Gallery Images (Max 5)</label>
<input type="file" name="gallery_images[]" multiple>

<br><br>

      <button type="submit">Update</button>
      <button type="button" onclick="closeEditModal()">Cancel</button>

    </form>
  </div>
</div>

<script>
  /* EXISTING DROPDOWN + EDIT LOGIC â€” UNTOUCHED */

  const sectionSelect = document.getElementById("sectionSelect");
  const subSectionSelect = document.getElementById("subSectionSelect");

  if (sectionSelect && subSectionSelect) {
    sectionSelect.addEventListener("change", () => {

      subSectionSelect.innerHTML = '<option value="">Select Sub Section</option>';

      if (!sectionSelect.value) return;

      fetch("/admin/api/subsections/" + sectionSelect.value)
        .then(res => res.json())
        .then(data => {
          data.forEach(sub => {
            const opt = document.createElement("option");
            opt.value = sub.id;
            opt.textContent = sub.name;
            subSectionSelect.appendChild(opt);
          });
        });
    });
  }


</script>
<script>
  const editModal = document.getElementById("editModal");
  const editForm = document.getElementById("editForm");
  const editSection = document.getElementById("editSection");
  const editSubSection = document.getElementById("editSubSection");

  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.addEventListener("click", () => {

      editForm.action = "/admin/products/edit/" + btn.dataset.id;

      document.getElementById("editName").value = btn.dataset.name;
      document.getElementById("editPrice").value = btn.dataset.price;
      document.getElementById("editQuantity").value = btn.dataset.quantity;
      document.getElementById("editDesc").value = btn.dataset.desc || "";

      editSection.value = btn.dataset.section;

      editSubSection.innerHTML = "";

      fetch("/admin/api/subsections/" + btn.dataset.section)
        .then(res => res.json())
        .then(data => {
          data.forEach(sub => {
            const opt = document.createElement("option");
            opt.value = sub.id;
            opt.textContent = sub.name;

            if (String(sub.id) === String(btn.dataset.subsection)) {
              opt.selected = true;
            }

            editSubSection.appendChild(opt);
          });
        });

      editModal.classList.add("active");
    });
  });

  editSection.addEventListener("change", () => {
    editSubSection.innerHTML = '<option value="">Select Sub Section</option>';

    if (!editSection.value) return;

    fetch("/admin/api/subsections/" + editSection.value)
      .then(res => res.json())
      .then(data => {
        data.forEach(sub => {
          const opt = document.createElement("option");
          opt.value = sub.id;
          opt.textContent = sub.name;
          editSubSection.appendChild(opt);
        });
      });
  });

  function closeEditModal() {
    editModal.classList.remove("active");
  }
</script>

<script>
  /* SEARCH + PAGINATION (ISOLATED SAFE SCRIPT) */

  const searchInput = document.getElementById("productSearch");
  const tableBody = document.getElementById("productTable");
  const pagination = document.getElementById("pagination");

  const rows = Array.from(tableBody.querySelectorAll("tr"));
  const rowsPerPage = 10;
  let currentPage = 1;
  let filteredRows = rows;

  function renderTable() {
    rows.forEach(row => row.style.display = "none");

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    filteredRows.slice(start, end).forEach(row => {
      row.style.display = "";
    });

    renderPagination();
  }

  function renderPagination() {
    pagination.innerHTML = "";
    const totalPages = Math.ceil(filteredRows.length / rowsPerPage);

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;

      if (i === currentPage) {
        btn.classList.add("active");
      }

      btn.addEventListener("click", () => {
        currentPage = i;
        renderTable();
      });

      pagination.appendChild(btn);
    }
  }

  searchInput.addEventListener("input", () => {
    const value = searchInput.value.toLowerCase();

    filteredRows = rows.filter(row =>
      row.dataset.name.includes(value)
    );

    currentPage = 1;
    renderTable();
  });

  renderTable();
</script>
<% if (successMessage) { %>
<script>
  const toast = document.getElementById("successToast");
  toast.style.display = "block";

  setTimeout(() => {
    toast.style.display = "none";
  }, 3000);
</script>
<% } %>


<!-- SUCCESS TOAST -->
<div id="successToast" class="toast-success">
  âœ… Product added successfully
</div>

</body>
</html>
